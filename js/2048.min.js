function taskClass(t,a,e){this.div=t,this.topStep=a,this.leftStep=e}var game={data:[],score:0,state:1,start:function(){this.data=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],this.score=0,this.state=1;var t=document.getElementById("gameover");t.style.display="none",this.randomNum(),this.randomNum(),this.updateView()},randomNum:function(){if(this.isFull())return 0;for(;;){var t=Math.floor(4*Math.random()),a=Math.floor(4*Math.random());if(0===this.data[t][a]){this.data[t][a]=Math.random()<.5?2:4;break}}},isFull:function(){for(var t=0;t<4;t++)for(var a=0;a<4;a++)if(0==this.data[t][a])return 0;return 1},updateView:function(){for(var t=0;t<4;t++)for(var a=0;a<4;a++){var e=document.getElementById("c"+t+a);e.innerHTML=0===this.data[t][a]?"":this.data[t][a],e.className=0===this.data[t][a]?"cell":"cell t"+this.data[t][a]}var i=document.getElementById("getscore");if(i.innerHTML=this.score,this.isGameOver()){this.state=0;var n=document.getElementById("gameover");n.style.display="block";var o=document.getElementById("finalscore");o.innerHTML=this.score}},isGameOver:function(){if(!this.isFull())return 0;for(var t=0;t<4;t++)for(var a=0;a<4;a++){if(a<3&&this.data[t][a]===this.data[t][a+1])return 0;if(t<3&&this.data[t][a]===this.data[t+1][a])return 0}return 1},moveLeft:function(){for(var t=0,a=0;a<4;a++)this.moveLeftInRow(a)&&(t=1);1===t&&(this.state=2,animation.move(),setTimeout(function(){game.state=1,game.randomNum(),game.updateView()},animation.times*animation.interval))},moveLeftInRow:function(t){for(var a=0,e=0;e<3;e++){var i=this.getNextRight(t,e);if(i===-1)break;0===this.data[t][e]?(this.data[t][e]=this.data[t][i],this.data[t][i]=0,animation.addTask("c"+t+i,"c"+t+e),e--,a=1):this.data[t][e]===this.data[t][i]&&(this.data[t][e]*=2,this.data[t][i]=0,this.score+=this.data[t][e],animation.addTask("c"+t+i,"c"+t+e),a=1)}return a},getNextRight:function(t,a){for(var e=a+1;e<4;e++)if(0!=this.data[t][e])return e;return-1},moveRight:function(){for(var t=0,a=0;a<4;a++)this.moveRightInRow(a)&&(t=1);1===t&&(this.state=2,animation.move(),setTimeout(function(){game.state=1,game.randomNum(),game.updateView()},animation.times*animation.interval))},moveRightInRow:function(t){for(var a=0,e=3;e>0;e--){var i=this.getNextLeft(t,e);if(i===-1)break;0===this.data[t][e]?(this.data[t][e]=this.data[t][i],this.data[t][i]=0,animation.addTask("c"+t+i,"c"+t+e),e++,a=1):this.data[t][e]===this.data[t][i]&&(this.data[t][e]*=2,this.data[t][i]=0,this.score+=this.data[t][e],animation.addTask("c"+t+i,"c"+t+e),a=1)}return a},getNextLeft:function(t,a){for(var e=a-1;e>=0;e--)if(0!=this.data[t][e])return e;return-1},moveTop:function(){for(var t=0,a=0;a<4;a++)this.moveTopInCol(a)&&(t=1);1===t&&(this.state=2,animation.move(),setTimeout(function(){game.state=1,game.randomNum(),game.updateView()},animation.times*animation.interval))},moveTopInCol:function(t){for(var a=0,e=0;e<3;e++){var i=this.getNextBottom(e,t);if(i===-1)break;0===this.data[e][t]?(this.data[e][t]=this.data[i][t],this.data[i][t]=0,animation.addTask("c"+i+t,"c"+e+t),e--,a=1):this.data[e][t]===this.data[i][t]&&(this.data[e][t]*=2,this.data[i][t]=0,this.score+=this.data[e][t],animation.addTask("c"+i+t,"c"+e+t),a=1)}return a},getNextBottom:function(t,a){for(var e=t+1;e<4;e++)if(0!=this.data[e][a])return e;return-1},moveBottom:function(){for(var t=0,a=0;a<4;a++)this.moveBottomInCol(a)&&(t=1);1===t&&(this.state=2,animation.move(),setTimeout(function(){game.state=1,game.randomNum(),game.updateView()},animation.times*animation.interval))},moveBottomInCol:function(t){for(var a=0,e=3;e>=0;e--){var i=this.getNextTop(e,t);if(i===-1)break;0===this.data[e][t]?(this.data[e][t]=this.data[i][t],this.data[i][t]=0,animation.addTask("c"+i+t,"c"+e+t),e++,a=1):this.data[e][t]===this.data[i][t]&&(this.data[e][t]*=2,this.data[i][t]=0,this.score+=this.data[e][t],animation.addTask("c"+i+t,"c"+e+t),a=1)}return a},getNextTop:function(t,a){for(var e=t-1;e>=0;e--)if(0!=this.data[e][a])return e;return-1}};game.start(),document.onkeydown=function(){if(2!=game.state){var t=window.event||arguments[0];1===game.state?37==t.keyCode?game.moveLeft():39==t.keyCode?game.moveRight():38==t.keyCode?game.moveTop():40==t.keyCode&&game.moveBottom():13==t.keyCode&&game.start()}};var animation={times:10,interval:10,timer:null,tasks:[],addTask:function(t,a){var e=document.getElementById(t),i=document.getElementById(a),n=(i.offsetTop-e.offsetTop)/this.times,o=(i.offsetLeft-e.offsetLeft)/this.times,s=new taskClass(e,n,o);this.tasks.push(s)},move:function(){this.timer=setInterval(function(){for(var t=0;t<animation.tasks.length;t++)animation.tasks[t].moveOneStep();if(animation.times--,0===animation.times){for(var t=0;t<animation.tasks.length;t++)animation.tasks[t].clear();clearInterval(animation.timer),animation.tasks=[],animation.times=10,animation.timer=null}},this.interval)}};taskClass.prototype.moveOneStep=function(){this.div.style.top=this.div.offsetTop+this.topStep+"px",this.div.style.left=this.div.offsetLeft+this.leftStep+"px"},taskClass.prototype.clear=function(){this.div.style.top="",this.div.style.left=""};var restart=document.getElementById("restart");restart.onclick=function(){event.stopPropagation(),game.start()},restart.addEventListener("touchstart",function(){event.stopPropagation(),game.start()},!1),restart.addEventListener("touchmove",function(){event.stopPropagation()},!1),restart.addEventListener("touchend",function(){event.stopPropagation()},!1);var init={minx:20,miny:20,sx:0,sy:0,ex:0,ey:0};document.addEventListener("touchstart",function(){var t=window.event||arguments[0];init.sx=t.targetTouches[0].pageX,init.sy=t.targetTouches[0].pageY,init.ex=init.sx,init.ey=init.sy},!1),document.addEventListener("touchmove",function(){var t=window.event||arguments[0];t.preventDefault(),init.ex=t.targetTouches[0].pageX,init.ey=t.targetTouches[0].pageY},!1),document.addEventListener("touchend",function(){if(2!=game.state&&1===game.state){var t=init.ex-init.sx,a=init.ey-init.sy;Math.abs(t)>Math.abs(a)&&Math.abs(t)>init.minx?t>0?game.moveRight():game.moveLeft():Math.abs(a)>Math.abs(t)&&Math.abs(a)>init.miny&&(a>0?game.moveBottom():game.moveTop())}},!1);